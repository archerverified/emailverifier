version: '3.8'

services:
  # ==========================================================================
  # Redis - Job State & Queue Backend
  # ==========================================================================
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - ./data/redis:/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ==========================================================================
  # Backend - Flask Email Verification API
  # ==========================================================================
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    restart: unless-stopped
    expose:
      - "5050"
    environment:
      # Server
      - PORT=${PORT:-5050}
      - HOST=0.0.0.0
      - FLASK_ENV=${FLASK_ENV:-production}
      
      # Validator
      - VALIDATOR_MODE=${VALIDATOR_MODE:-real}
      
      # Redis (for job state and RQ)
      - REDIS_URL=redis://redis:6379/0
      - USE_WORKER_QUEUE=${USE_WORKER_QUEUE:-true}
      
      # Upload limits
      - MAX_UPLOAD_MB=${MAX_UPLOAD_MB:-25}
      - MAX_CSV_ROWS=${MAX_CSV_ROWS:-10000}
      - MAX_LINE_LENGTH=${MAX_LINE_LENGTH:-10000}
      
      # SMTP/DNS Configuration
      - SMTP_TIMEOUT_SECONDS=${SMTP_TIMEOUT_SECONDS:-20}
      - DNS_TIMEOUT_SECONDS=${DNS_TIMEOUT_SECONDS:-5}
      - SMTP_RETRIES=${SMTP_RETRIES:-1}
      - RETRY_BACKOFF_MS=${RETRY_BACKOFF_MS:-900}
      - SMTP_GLOBAL_WORKERS=${SMTP_GLOBAL_WORKERS:-15}
      - SMTP_PER_DOMAIN_LIMIT=${SMTP_PER_DOMAIN_LIMIT:-2}
      - DNS_CACHE_TTL_MINUTES=${DNS_CACHE_TTL_MINUTES:-30}
      - CATCH_ALL_CACHE_TTL_MINUTES=${CATCH_ALL_CACHE_TTL_MINUTES:-1440}
      
      # Job management
      - MAX_CONCURRENT_JOBS=${MAX_CONCURRENT_JOBS:-3}
      - JOB_STALL_TIMEOUT_MINUTES=${JOB_STALL_TIMEOUT_MINUTES:-60}
      - JOB_HEARTBEAT_INTERVAL_ROWS=${JOB_HEARTBEAT_INTERVAL_ROWS:-10}
      - JOB_HEARTBEAT_INTERVAL_SECONDS=${JOB_HEARTBEAT_INTERVAL_SECONDS:-15}
      
      # Retention
      - RETENTION_DAYS=${RETENTION_DAYS:-14}
      - MAX_JOBS=${MAX_JOBS:-200}
      
      # Security
      - APP_API_KEY=${APP_API_KEY:-}
      
      # Rate limiting
      - RATE_LIMIT_IP_PER_MINUTE=${RATE_LIMIT_IP_PER_MINUTE:-10}
      - RATE_LIMIT_KEY_PER_MINUTE=${RATE_LIMIT_KEY_PER_MINUTE:-100}
      
      # Storage (container paths - mounted from host)
      - STORAGE_DIR=/app/storage
      - DB_PATH=/app/storage/lead_validator.db
      
      # CORS
      - CORS_ORIGINS=${CORS_ORIGINS:-}
      
      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      
      # Gunicorn (can now use multiple workers with Redis!)
      - GUNICORN_WORKERS=${GUNICORN_WORKERS:-2}
      - GUNICORN_THREADS=${GUNICORN_THREADS:-4}
      - GUNICORN_TIMEOUT=${GUNICORN_TIMEOUT:-180}
    volumes:
      # Persist SQLite database and job outputs
      - ./data/storage:/app/storage
    networks:
      - app-network
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:5050/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # ==========================================================================
  # Worker - RQ Background Job Processor
  # ==========================================================================
  worker:
    build:
      context: .
      dockerfile: backend/Dockerfile
    restart: unless-stopped
    command: rq worker --with-scheduler -c worker_settings
    environment:
      # Redis
      - REDIS_URL=redis://redis:6379/0
      
      # Validator
      - VALIDATOR_MODE=${VALIDATOR_MODE:-real}
      
      # SMTP/DNS Configuration
      - SMTP_TIMEOUT_SECONDS=${SMTP_TIMEOUT_SECONDS:-20}
      - DNS_TIMEOUT_SECONDS=${DNS_TIMEOUT_SECONDS:-5}
      - SMTP_RETRIES=${SMTP_RETRIES:-1}
      - RETRY_BACKOFF_MS=${RETRY_BACKOFF_MS:-900}
      - SMTP_GLOBAL_WORKERS=${SMTP_GLOBAL_WORKERS:-15}
      - SMTP_PER_DOMAIN_LIMIT=${SMTP_PER_DOMAIN_LIMIT:-2}
      - DNS_CACHE_TTL_MINUTES=${DNS_CACHE_TTL_MINUTES:-30}
      - CATCH_ALL_CACHE_TTL_MINUTES=${CATCH_ALL_CACHE_TTL_MINUTES:-1440}
      
      # Job management
      - JOB_HEARTBEAT_INTERVAL_ROWS=${JOB_HEARTBEAT_INTERVAL_ROWS:-10}
      - JOB_HEARTBEAT_INTERVAL_SECONDS=${JOB_HEARTBEAT_INTERVAL_SECONDS:-15}
      
      # Storage
      - STORAGE_DIR=/app/storage
      - DB_PATH=/app/storage/lead_validator.db
      
      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./data/storage:/app/storage
    networks:
      - app-network
    depends_on:
      redis:
        condition: service_healthy
      backend:
        condition: service_healthy

  # ==========================================================================
  # Caddy - Reverse Proxy with Automatic HTTPS
  # ==========================================================================
  caddy:
    image: caddy:2-alpine
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      # Serve frontend static files directly from Caddy
      - ./frontend:/srv/frontend:ro
      - ./data/caddy/data:/data
      - ./data/caddy/config:/config
    environment:
      - DOMAIN=${DOMAIN:-localhost}
    networks:
      - app-network
    depends_on:
      backend:
        condition: service_healthy

# ==========================================================================
# Networks
# ==========================================================================
networks:
  app-network:
    driver: bridge
